<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src vscode-resource:; script-src 'unsafe-inline' {{cspSource}}; style-src vscode-resource: 'unsafe-inline' {{cspSource}};">
        
        <!-- <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src vscode-resource:; script-src 'unsafe-inline' {{cspSource}} vscode-resource:; style-src vscode-resource: 'unsafe-inline' {{cspSource}};">
     -->
   
    <title>ELFInsight Webview</title>
    <link rel="stylesheet" href="{{bootstrapUri}}">
    <script src="{{popperJsUri}}"></script>
    <script src="{{chartJsUri}}"></script>
    <script src="{{bootstrapJsUri}}"></script>
    <style>
        /* Increase size of the left column (table) and add scrolling */
        .scrollable-table {
            max-height: 500px;
            max-width: 100%;
            overflow-y: auto;
            overflow-x: auto;
        }
    
        /* Center align all table texts */
        #symbolsTable td,
        #symbolsTable th {
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 1.5em;
        }
    
        /* Adjust the table layout for better responsiveness */
        #symbolsTable {
            table-layout: fixed;
            width: 100%;
        }
    
        /* Set specific column widths */
        #symbolsTable th:nth-child(1),
        #symbolsTable td:nth-child(1) {
            width: 120px;
        }
    
        #symbolsTable th:nth-child(2),
        #symbolsTable td:nth-child(2) {
            width: 75px;
        }
    
        #symbolsTable th:nth-child(3),
        #symbolsTable td:nth-child(3) {
            width: 75px;
        }
    
        #symbolsTable th:nth-child(4),
        #symbolsTable td:nth-child(4) {
            width: 75px;
        }
    
        /* Reduce the size of the right column (for the bar chart) */
        .col-md-4 {
            padding: 15px;
            max-width: 25%;
        }
    
        /* Limit the size of the pie chart */
        #memoryPieChart {
            max-width: 300px;
            max-height: 300px;
            width: 100%;
            height: auto;
        }
    
        /* Center the pie chart inside the right column */
        .right-column,
        .pie-column {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    
        /* Bar chart styling */
        .chart-border {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            height: 100%;
            display: flex;
            align-items: center;
        }
    
        #memoryBarChart {
            width: 100% !important;
            height: 100% !important;
            max-height: 350px;
        }
    
        /* Right column content centered */
        .divider {
            height: 100%;
        }
    
        /* Memory list adjustments */
        .memory-list, .list-group{
           
            width: 100%;
        }
    
        /* Highlighted text styling */
        mark {
            background-color: #ffeb3b;
            color: black;
            padding: 0;
            border-radius: 2px;
        }
    
        /* Ensure the container takes up the full width and no padding */
        .container-fluid {
            padding-left: 0;
            padding-right: 0;
        }
    </style>
    
</head>

<body>
 
   <!-- Bootstrap Tabs Navigation -->
<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link active" data-bs-toggle="tab" href="#overview" aria-selected="true" role="tab">Overview</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="tab" href="#callGraphs" aria-selected="false" role="tab">Call Graphs</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="tab" href="#detailedReports" aria-selected="false" role="tab">Detailed Reports</a>
  </li>
</ul>

<!-- Bootstrap Tab Content -->
<div id="myTabContent" class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="container-fluid">
        <!-------------------------------------------- First Row: Intro Text and Button --------------------------->
        <div class="row">
            <div class="col-12">
                <h1 class="mt-5">ELFInsight!</h1>
                <button id="loadSymbolsButton" class="btn btn-outline-primary mt-3">Load ELF</button>
            </div>
        </div>
  
        <!-- First Row: Bar Chart and Memory Section Info -->
        <div class="row mt-4 d-flex align-items-stretch">
            <div class="col-md-7 bar-column d-flex">
                <div class="chart-border flex-fill">
                    <canvas id="memoryBarChart"></canvas>
                </div>
            </div>
  
            <!-- Right Column: Memory Section Info -->
            <div class="col-md-5 d-flex">
                <div class="divider flex-fill d-flex flex-column justify-content-center">
                    <div class="memory-list w-100">
                        <h3>Memory Sections:</h3>
                        <ul class="list-group w-100 mb-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Text (Flash)
                                <span class="badge bg-info rounded-pill"><span id="textSectionSize">0</span> bytes</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                BSS (RAM)
                                <span class="badge bg-success rounded-pill"><span id="bssSectionSize">0</span> bytes</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Data (Flash & RAM)
                                <span class="badge bg-secondary rounded-pill"><span id="dataSectionSize">0</span> bytes</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                RO Data (Flash)
                                <span class="badge bg-danger rounded-pill"><span id="rodataSectionSize">0</span> bytes</span>
                            </li>
                        </ul>
  
                        <h3>Total Memory Usage:</h3>
                        <ul class="list-group w-100">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Static RAM usage (boot-time)
                                <span class="badge bg-dark rounded-pill"><span id="totalRamUsed">0</span> bytes</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Flash usage
                                <span class="badge bg-dark rounded-pill"><span id="totalFlashUsed">0</span> bytes</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
  
        <!-- Second Row: Symbol Table -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="search-section mt-3">
                    <h4>Search Symbols</h4>
                    <div class="input-group mb-3">
                        <input type="text" id="searchInput" class="form-control" placeholder="Enter symbol name">
                        <button class="btn btn-outline-secondary" type="button" id="searchButton">Search</button>
                    </div>
                </div>
                <div class="scrollable-table">
                    <table id="symbolsTable" class="table table-bordered">
                        <thead>
                            <tr>
                                <th id="nameHeader" style="cursor: pointer;">Name &#x21C5;</th>
                                <th id="sectionHeader" style="cursor: pointer;">Section &#x21C5;</th>
                                <th id="sizeHeader" style="cursor: pointer;">Size &#x21C5;</th>
                                <th>Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
      </div>
    </div>
  
    <!-- Call Graphs Tab (placeholder content) -->
    <div class="tab-pane fade" id="callGraphs" role="tabpanel" aria-labelledby="callGraphs-tab">
      <p>Call graph visualization and analysis will be added here.</p>
    </div>
  
    <!-- Detailed Reports Tab (placeholder content) -->
    <div class="tab-pane fade" id="detailedReports" role="tabpanel" aria-labelledby="detailedReports-tab">
      <p>Detailed reports and insights will be added here.</p>
    </div>
  </div>

            <script>
                (function () {
                    const vscode = acquireVsCodeApi();
                    let symbolsData = [];
                    let sizeSortOrder = 1;
                    let nameSortOrder = 1;
                    let sectionSizes = {};

                    // Restore state if available
                    const previousState = vscode.getState();
                    if (previousState) {
                        symbolsData = previousState.symbolsData || [];
                        sizeSortOrder = previousState.sizeSortOrder || 1;
                        nameSortOrder = previousState.nameSortOrder || 1;
                        sectionSizes = previousState.sectionSizes || {};  // Restore full sectionSizes

                        // Re-apply the saved state to the HTML elements
                        updateTable(symbolsData);
                        updateBarChart(sectionSizes); // Call the new bar chart update function

                        // Restore section sizes in text
                        document.getElementById('textSectionSize').textContent = sectionSizes.text || 0;
                        document.getElementById('bssSectionSize').textContent = sectionSizes.bss || 0;
                        document.getElementById('dataSectionSize').textContent = sectionSizes.data || 0;
                        document.getElementById('rodataSectionSize').textContent = sectionSizes.rodata || 0;

                        // Restore flash and RAM usage
                        document.getElementById('totalFlashUsed').textContent = previousState.flashUsed || 0;
                        document.getElementById('totalRamUsed').textContent = previousState.ramUsed || 0;
                    }
                    // Add event listener for the search button
                    document.getElementById('searchButton').addEventListener('click', performSearch);

                    // Allow pressing 'Enter' to trigger the search
                    document.getElementById('searchInput').addEventListener('keyup', function (event) {
                        if (event.key === 'Enter') {
                            performSearch();
                        }
                    });

                    // Optional: Update table as user types
                    document.getElementById('searchInput').addEventListener('input', performSearch);


                    // Load symbols when button is clicked
                    document.getElementById('loadSymbolsButton').addEventListener('click', () => {
                        vscode.postMessage({ command: 'loadSymbols' });
                    });

                    // Sort by size when size header is clicked
                    document.getElementById('sizeHeader').addEventListener('click', () => {
                        symbolsData.sort((a, b) => {
                            const sizeA = parseInt(a.size); // Parse size as integer
                            const sizeB = parseInt(b.size);
                            return sizeSortOrder * (sizeA - sizeB);  // Sort ascending or descending
                        });
                        sizeSortOrder *= -1;  // Reverse sort order for next click
                        updateTable(symbolsData);
                        saveState();  // Save the updated state
                    });

                    // Sort by name when name header is clicked
                    document.getElementById('nameHeader').addEventListener('click', () => {
                        symbolsData.sort((a, b) => {
                            const nameA = a.name.toLowerCase();
                            const nameB = b.name.toLowerCase();
                            if (nameA < nameB) return nameSortOrder * -1;
                            if (nameA > nameB) return nameSortOrder * 1;
                            return 0;
                        });
                        nameSortOrder *= -1;  // Reverse sort order for next click
                        updateTable(symbolsData);
                        saveState();  // Save the updated state
                    });
                    document.addEventListener('DOMContentLoaded', function () {
                        var tabs = document.querySelectorAll('.nav-link');
                        tabs.forEach(function (tab) {
                            tab.addEventListener('click', function (event) {
                                event.preventDefault();
                                var target = this.getAttribute('href');
                                document.querySelectorAll('.tab-pane').forEach(function (pane) {
                                    pane.classList.remove('active', 'show');
                                });
                                document.querySelector(target).classList.add('active', 'show');
                            });
                        });
                    });

                    // Sort by section (badge text) NOT WORKING
                    // document.getElementById('sectionHeader').addEventListener('click', () => {
                    //     symbolsData.sort((a, b) => {
                    //         const sectionA = getBadgeText(a.section);
                    //         const sectionB = getBadgeText(b.section);
                    //         if (sectionA < sectionB) return sectionSortOrder * -1;
                    //         if (sectionA > sectionB) return sectionSortOrder * 1;
                    //         return 0;
                    //     });
                    //     sectionSortOrder *= -1;
                    //     updateTable(symbolsData);
                    // });               

                    // Event listener to receive messages from the extension
                    window.addEventListener('message', event => {
                        const message = event.data;

                        if (message.command === 'displaySymbols') {
                            symbolsData = message.symbols || [];
                            sectionSizes = message.sectionSizes || {};
                            updateTable(symbolsData);
                            updateBarChart(sectionSizes); // Call the new bar chart update function

                            // Update the section size text
                            document.getElementById('textSectionSize').textContent = sectionSizes.text || 0;
                            document.getElementById('bssSectionSize').textContent = sectionSizes.bss || 0;
                            document.getElementById('dataSectionSize').textContent = sectionSizes.data || 0;
                            document.getElementById('rodataSectionSize').textContent = sectionSizes.rodata || 0;

                            // Update total flash and RAM usage
                            document.getElementById('totalFlashUsed').textContent = message.flashUsed || 0;
                            document.getElementById('totalRamUsed').textContent = message.ramUsed || 0;

                            // Save the current state
                            saveState();
                        }
                    });
                    // Function to update the table
                    // Modify updateTable to accept query parameter for highlighting
                    function updateTable(data, query = '') {
                        const symbolsTableBody = document.querySelector('#symbolsTable tbody');

                        if (!symbolsTableBody) {
                            console.error("Table body not found");
                            return;
                        }

                        // Clear existing rows
                        symbolsTableBody.innerHTML = '';

                        if (!data || data.length === 0) {
                            // Display a message when no data is available
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="5">No symbols found.</td>`;
                            symbolsTableBody.appendChild(row);
                            return;
                        }

                        data.forEach(symbol => {
                            const row = document.createElement('tr');
                            let badgeClass = '';

                            // Determine badge class based on section
                            switch (symbol.section) {
                                case '.text':
                                    badgeClass = 'bg-info';
                                    break;
                                case '.bss':
                                    badgeClass = 'bg-success';
                                    break;
                                case '.data':
                                    badgeClass = 'bg-secondary';
                                    break;
                                case '.rodata':
                                    badgeClass = 'bg-danger';
                                    break;
                                default:
                                    badgeClass = 'bg-dark';
                            }

                            // Highlight matching text in the symbol name
                            let symbolName = symbol.name;
                            if (query) {
                                const regex = new RegExp(`(${query})`, 'gi');
                                symbolName = symbolName.replace(regex, '<mark>$1</mark>');
                            }

                            row.innerHTML = `
            <td>${symbolName}</td>
            <td><span class="badge ${badgeClass}">${symbol.section}</span></td>
            <td>${symbol.size}</td>
            <td>${symbol.address}</td>
           
        `;

                            symbolsTableBody.appendChild(row);
                        });
                    }
                    function performSearch() {
                        const query = document.getElementById('searchInput').value.toLowerCase().trim();

                        if (!query) {
                            // If the search query is empty, display all symbols
                            updateTable(symbolsData);
                            return;
                        }

                        // Filter symbolsData based on the search query
                        const filteredData = symbolsData.filter(symbol => symbol.name.toLowerCase().includes(query));

                        // Update the table with the filtered data
                        updateTable(filteredData, query);
                    }

                    // Function to update the bar chart
                    function updateBarChart(sectionSizes) {
                        const ctx = document.getElementById('memoryBarChart').getContext('2d');

                        if (!sectionSizes || !ctx) {
                            console.error('No data provided for the bar chart or canvas context is missing');
                            return;
                        }

                        const chartData = {
                            labels: ['.text', '.bss', '.data', '.rodata'],
                            datasets: [{
                                label: 'Memory Usage (Bytes)',
                                data: [
                                    sectionSizes.text || 0,
                                    sectionSizes.bss || 0,
                                    sectionSizes.data || 0,
                                    sectionSizes.rodata || 0
                                ],
                                backgroundColor: ['#36a2eb', '#4caf50', '#ffcd56', '#ff6384']
                            }]
                        };

                        new Chart(ctx, {
                            type: 'bar',
                            data: chartData,
                            options: {
                                maintainAspectRatio: false,
                                responsive: true,
                                animation: {
                                    duration: 1000,  // Set duration of animation in milliseconds (e.g., 1000ms = 1 second)
                                    easing: 'easeOutBounce'  // Easing function for the animation
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Bytes'
                                        },
                                        grid: {
                                            color: 'rgba(200, 200, 200, 0.3)',  // Lighter color for gridlines
                                            lineWidth: 1,                      // Thinner gridlines
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Sections'
                                        },
                                        grid: {
                                            color: 'rgba(200, 200, 200, 0.3)',  // Lighter color for gridlines
                                            lineWidth: 1,                      // Thinner gridlines
                                        }
                                    }
                                }
                            }
                        });




                    }

                    // Function to save the current state of the webview
                    function saveState() {
                        vscode.setState({
                            symbolsData,
                            sizeSortOrder,
                            nameSortOrder,
                            sectionSizes,  // Save full sectionSizes object
                            flashUsed: document.getElementById('totalFlashUsed').textContent || 0,
                            ramUsed: document.getElementById('totalRamUsed').textContent || 0
                        });
                    }
                }());
            </script>
</body>

</html>